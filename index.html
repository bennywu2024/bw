<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sherwood Bus App</title>
    
    <meta name="application-name" content="Sherwood Bus">
    <meta name="apple-mobile-web-app-title" content="Sherwood Bus">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#FFFFFF">

    <!-- Icons -->
    <link rel="icon" href="https://bennywu2024.github.io/bw/icon.png?v=2">
    <link rel="apple-touch-icon" href="https://bennywu2024.github.io/bw/icon.png?v=2">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Styles -->
    <style>
        /* --- Base and Scrollbar --- */
        html, body {
            margin: 0;
            padding: 0;
            min-height: 100%;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            position: relative;
            overflow-x: hidden;
            /* Use Inter as a modern default, with fallbacks */
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        #background-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            background-image: linear-gradient(rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.85)), url('https://bennywu2024.github.io/bw/background.jpeg');
            background-size: cover;
            background-position: center;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* --- Liquid Glass Effect --- */
        .glass-card {
            background: rgba(255, 255, 255, 0.2);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
        }

        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: rgba(255, 255, 255, 0.2) !important;
            backdrop-filter: blur(5px) !important;
            -webkit-backdrop-filter: blur(5px) !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 30px rgba(0,0,0,0.1) !important;
            padding: 0.75rem 1rem !important;
        }
        
        .main-content-container {
            padding-top: 72px;  /* Height of fixed-header */
            padding-bottom: 120px; /* Space for bottomNav */
        }

        /* --- Typography and Element Styling --- */
        h2, h3, p, .timetable-table th { color: #1e293b; }
        #geolocationMessage { color: #334155; font-weight: 500; }
        .countdown-text { font-weight: 500; color: #166534; }
        .departed-text { color: #991b1b; font-weight: 500; }
        
        /* --- Buttons --- */
        .pill-button-group button, .location-button-group button {
            background-color: rgba(229, 231, 235, 0.7);
            color: #4b5563;
            transition: all 0.2s ease-in-out;
            border-radius: 9999px;
            border: 1px solid rgba(203, 213, 225, 0.5);
        }
        .pill-button-group button.selected, .location-button-group button.selected {
            background-color: #1f2937;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-color: transparent;
        }

        .main-tab-button {
            transition: all 0.2s ease-in-out;
            color: #6b7280;
        }
        .main-tab-button.selected {
            color: #2563eb;
        }
        
        #refreshButton {
            background: rgba(255, 255, 255, 0.4);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(203, 213, 225, 0.6);
            color: #1e3a8a;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        #refreshButton:hover {
            background: rgba(255, 255, 255, 0.6);
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        #refreshButton:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #departuresDisplay {
            display: flex;
            flex-direction: column;
            gap: 2.5rem; /* Consistent spacing between cards */
        }

        /* --- Highlights & Icons --- */
        .next-departure-highlight { background-color: rgba(239, 246, 255, 0.7) !important; border: 2px solid #3b82f6; font-weight: 700; }
        .next-departure-highlight-green { background-color: rgba(220, 252, 231, 0.7) !important; border: 2px solid #16a34a !important; }
        .next-departure-highlight-yellow { background-color: rgba(254, 252, 232, 0.7) !important; border: 2px solid #ca8a04 !important; }
        .next-departure-highlight-blue { background-color: rgba(219, 234, 254, 0.7) !important; border: 2px solid #2563eb !important; }
        .next-departure-highlight-orange { background-color: rgba(255, 247, 237, 0.7) !important; border: 2px solid #f97316 !important; }
        /* --- NEW LWB Highlight --- */
        .next-departure-highlight-purple { background-color: rgba(237, 233, 254, 0.7) !important; border: 2px solid #6d28d9 !important; } 


        /* --- Timetable --- */
        .timetable-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;  
        }
        .timetable-table th, .timetable-table td {
            border: 1px solid rgba(203, 213, 225, 0.8);
            padding: 0.5rem;  
            text-align: left;
        }
        .timetable-table th {
            background-color: rgba(226, 232, 240, 0.4);
            font-weight: 600;
        }
        .timetable-highlight-hour {
            background-color: rgba(224, 231, 255, 0.6);
            font-weight: bold;
        }
        .timetable-highlight-minute {
            background-color: #3b82f6;
            color: white;  
            font-weight: bold;
            padding: 0.125rem 0.375rem;
            border-radius: 9999px;
        }

        /* --- Pull To Refresh --- */
        #pullToRefreshIndicator {
            position: fixed;
            top: 72px; /* Below fixed header */
            left: 0;
            right: 0;
            height: 0;  
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(220, 230, 255, 0.7);  
            color: #1e3a8a;  
            z-index: 50;  
            overflow: hidden;
            transition: height 0.2s ease-out, opacity 0.2s ease-out;
            opacity: 0;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Background Container -->
    <div id="background-container"></div>
    
    <!-- Header -->
    <header class="fixed-header flex justify-between items-center">
        <div class="w-10 h-10"></div> 
        <div class="flex-grow flex justify-center items-center">
            <div class="p-2 rounded-full glass-card">
                <img src="https://bennywu2024.github.io/bw/topicon.png" class="h-6 w-6">
            </div>
        </div>
        <div class="w-10 h-10"></div> 
    </header>
    
    <!-- Pull to Refresh Indicator -->
    <div id="pullToRefreshIndicator">
        <svg id="pullRefreshSpinner" class="animate-spin h-6 w-6 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span id="pullRefreshText" class="ml-2 text-sm"></span>
    </div>

    <!-- Main Content Area -->
    <div class="main-content-container">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-3xl">
            
            <!-- ETA View -->
            <div id="etaView" class="view-section">
                <!-- Location Selector -->
                <section class="location-section mb-10 p-4 rounded-xl glass-card">
                    <h2 class="text-xl font-semibold mb-3 text-center">現在位置</h2>
                    <div id="locationSelector" class="flex flex-col space-y-2 location-button-group p-2">
                        <!-- Location buttons generated by JS -->
                    </div>
                    <p id="geolocationMessage" class="text-center mt-2 hidden"></p>
                </section>

                <!-- Departures Display -->
                <section id="departuresDisplay" class="flex flex-col gap-10">
                    
                    <!-- Light Rail -->
                    <div id="lightRailSection" class="p-5 rounded-xl glass-card hidden">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-2xl font-bold" style="color: #ca8a04;">輕鐵</h3>
                        </div>
                        <p id="lightRailSubtitle" class="text-md font-medium mb-3"></p>
                        <ul id="lightRailDepartures" class="space-y-2"></ul>
                        <p id="lightRailMessage" class="mt-3 text-sm"></p>
                    </div>
                    
                    <!-- KMB -->
                    <div id="kmbSection" class="p-5 rounded-xl glass-card hidden">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-2xl font-bold" style="color: #16a34a;">九巴路線</h3>
                        </div>
                        <p id="kmbSubtitle" class="text-md font-medium mb-3"></p>
                        <ul id="kmbDepartures" class="space-y-2"></ul>
                        <p id="kmbMessage" class="mt-3 text-sm"></p>
                    </div>

                    <!-- LWB Section -->
                    <div id="lwbSection" class="p-5 rounded-xl glass-card hidden">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-2xl font-bold" style="color: #6d28d9;">龍運路線</h3> 
                        </div>
                        <p id="lwbSubtitle" class="text-md font-medium mb-3"></p>
                        <ul id="lwbDepartures" class="space-y-2"></ul>
                        <p id="lwbMessage" class="mt-3 text-sm"></p>
                    </div>

                    <!-- NLB Section -->
                    <div id="nlbSection" class="p-5 rounded-xl glass-card hidden">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-2xl font-bold" style="color: #1d4ed8;">嶼巴路線</h3> 
                        </div>
                        <p id="nlbSubtitle" class="text-md font-medium mb-3"></p>
                        <ul id="nlbDepartures" class="space-y-2"></ul>
                        <p id="nlbMessage" class="mt-3 text-sm"></p>
                    </div>

                    <!-- CTB Section -->
                    <div id="ctbSection" class="p-5 rounded-xl glass-card hidden">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-2xl font-bold" style="color: #ea580c;">城巴路線</h3> 
                        </div>
                        <p id="ctbSubtitle" class="text-md font-medium mb-3"></p>
                        <ul id="ctbDepartures" class="space-y-2"></ul>
                        <p id="ctbMessage" class="mt-3 text-sm"></p>
                    </div>

                    <!-- NR762 -->
                    <div id="nr762Section" class="p-5 rounded-xl glass-card hidden">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-2xl font-bold" style="color: #4f46e5;">NR762</h3>
                        </div>
                        <p id="nr762Route" class="text-md font-medium mb-3"></p>
                        <ul id="nr762Departures" class="space-y-2">
                        </ul>
                        <p id="nr762Message" class="mt-3 text-sm"></p>
                    </div>

                    <!-- NR762A -->
                    <div id="nr762aSection" class="p-5 rounded-xl glass-card hidden">
                         <div class="flex justify-between items-center mb-2">
                            <h3 class="text-2xl font-bold" style="color: #0d9488;">NR762A</h3>
                         </div>
                        <p id="nr762aRoute" class="text-md font-medium mb-3"></p>
                        <ul id="nr762aDepartures" class="space-y-2">
                        </ul>
                        <p id="nr762aMessage" class="mt-3 text-sm"></p>
                    </div>

                </section>
            </div>

            <!-- Timetable View -->
            <div id="timetableView" class="view-section hidden p-5 rounded-xl glass-card">
                <div id="timetableSubSwitcher" class="mb-6 flex justify-center space-x-2 sm:space-x-4 pill-button-group">
                    <button id="nr762SubTabButton" class="px-4 py-2 rounded-full font-semibold text-sm">NR762</button>
                    <button id="nr762aSubTabButton" class="px-4 py-2 rounded-full font-semibold text-sm">NR762A</button>
                </div>

                <!-- NR762 Timetable -->
                <div id="timetableContentNR762" class="timetable-route-section">
                    <h3 class="text-xl font-semibold text-indigo-800 mb-3 text-center">NR762: 豫豐花園 ↔ 兆康站</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-medium text-gray-700 mb-2 text-center">由 豫豐花園 開出</h4>
                            <div id="nr762_richwood_timetable_container"></div>
                        </div>
                        <div>
                            <h4 class="text-lg font-medium text-gray-700 mb-2 text-center">由 兆康站 開出</h4>
                            <div id="nr762_siuhong_timetable_container"></div>
                        </div>
                    </div>
                </div>
                
                <!-- NR762A Timetable -->
                <div id="timetableContentNR762A" class="timetable-route-section hidden">
                    <h3 class="text-xl font-semibold text-teal-800 mb-3 text-center">NR762A: 豫豐花園 ↔ 屯門市中心</h3>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-medium text-gray-700 mb-2 text-center">由 豫豐花園 開出</h4>
                            <div id="nr762a_richwood_timetable_container"></div>
                        </div>
                        <div>
                            <h4 class="text-lg font-medium text-gray-700 mb-2 text-center">由 屯門市中心 開出</h4>
                            <div id="nr762a_tuenmun_timetable_container"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <footer class="mt-8 text-center text-sm text-gray-500">
                <button id="refreshButton" class="px-6 py-3 rounded-lg shadow-md">
                    刷新班次
                </button>
                <p class="text-gray-600 mt-4">巴士班次資料僅供參考，以實際營運為準。</p>
            </footer>
        </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <div id="bottomNav" class="fixed bottom-0 left-0 right-0 z-50 px-4 pb-4 pt-2">
        <div class="glass-card rounded-2xl flex justify-around items-center max-w-sm mx-auto p-1 shadow-lg">
            <button id="bottomNavOutButton" class="main-tab-button flex-1 flex flex-col items-center space-y-1 p-2 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                <span class="text-xs font-medium">外出</span>
            </button>
            <button id="bottomNavHomeButton" class="main-tab-button flex-1 flex flex-col items-center space-y-1 p-2 rounded-lg">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                 <span class="text-xs font-medium">回家</span>
            </button>
            <button id="bottomNavTimetableButton" class="main-tab-button flex-1 flex flex-col items-center space-y-1 p-2 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M12 12.75h.008v.008H12v-.008Z" /></svg>
                <span class="text-xs font-medium">村巴時間表</span>
            </button>
        </div>
    </div>
    
    <!-- UPDATED JAVASCRIPT -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            /**
             * Main application object to encapsulate all logic and state.
             */
            const App = {
                // 1. STATE
                state: { /* ... state properties ... */ 
                    currentView: 'etaView',      
                    currentDirection: 'out',     
                    currentLocationName: null,   
                    countdownIntervalId: null, 
                    userPosition: null,          
                    isRefreshing: false,         
                    ptrTouchStartY: 0,         
                    ptrThreshold: 80,          
                },

                // 2. CONFIG
                config: {
                    allSchedules: { /* ... NR schedules ... */ 
                        "NR762": {
                            "豫豐花園_to_兆康站": { 6: [15, 30, 45], 7: [0, 15, 30, 45], 8: [0, 15, 30, 45], 9: [0], 10: [5, 20, 40], 11: [0, 20, 40], 12: [0], 14: [5, 20, 40], 15: [0, 20, 40], 16: [0], 18: [15, 30, 45], 19: [0, 15, 30, 45], 21: [15, 45], 22: [0] },
                            "兆康站_to_豫豐花園": { 6: [20, 35, 50], 7: [5, 20, 35, 50], 8: [5, 20, 35, 50], 9: [5], 10: [10, 25, 45], 11: [5, 25, 45], 12: [5], 14: [10, 25, 45], 15: [5, 25, 45], 16: [5], 18: [20, 35, 50], 19: [5, 20, 35, 50], 21: [20, 50], 22: [5] }
                        },
                        "NR762A": {
                            "豫豐花園_to_屯門市中心": { 7: [30], 8: [0, 30], 9: [0, 15, 30, 45], 10: [0, 30], 11: [0, 30], 12: [0, 15, 30, 45], 13: [0, 15, 30, 45], 14: [0, 30], 15: [0, 30], 16: [0, 15, 30, 45], 17: [0, 15, 30, 45], 18: [0], 19: [30], 20: [0, 15, 30, 45], 21: [0, 30], 22: [0, 15, 30, 45], 23: [0, 15] },
                            "屯門市中心_to_豫豐花園": { 7: [40], 8: [10, 40], 9: [10, 25, 40, 55], 10: [10, 40], 11: [10, 40], 12: [10, 25, 40, 55], 13: [10, 25, 40, 55], 14: [10, 40], 15: [10, 40], 16: [10, 25, 40, 55], 17: [10, 25, 40, 55], 18: [10], 19: [40], 20: [10, 25, 40, 55], 21: [10, 40], 22: [10, 25, 40, 55], 23: [10, 30] }
                        }
                    },
                    locations: {
                        "out": [
                            { name: "豫豐花園", lat: 22.4193, lon: 113.9855 },
                            { name: "福亨村", lat: 22.422574, lon: 113.985749 },
                            { name: "妙法寺", lat: 22.420492, lon: 113.983893 },
                            { name: "藍地站 (南行)", lat: 22.4184, lon: 113.9822 },
                            { name: "藍地站 (北行)", lat: 22.4184, lon: 113.9822 },
                            { name: "富泰邨", lat: 22.412973, lon: 113.982399 },
                            { name: "紅橋", lat: 22.401816, lon: 113.977423 },
                            // --- RENAMED ---
                            { name: "富泰邨 (北行)", lat: 22.412973, lon: 113.982399 },
                            // --- END ---
                            { name: "屯門公路轉車站", lat: 22.362689, lon: 114.015770 } 
                        ],
                        "home": [
                            { name: "兆康站", lat: 22.4131, lon: 113.9793 },
                            { name: "屯門市中心", lat: 22.3957, lon: 113.9753 },
                            { name: "屯公轉車站 (屯門方向)", lat: 22.3585, lon: 114.0185 },
                            { name: "新墟街市", lat: 22.398858, lon: 113.976525 },
                            { name: "紅橋 (回家)", lat: 22.402437, lon: 113.977155, displayName: "紅橋" },
                            { name: "深圳灣口岸", lat: 22.5085, lon: 113.9488 } 
                        ]
                    },
                    destinations: { /* ... destinations ... */ 
                        "豫豐花園": { "NR762": "兆康站", "NR762A": "屯門市中心" },
                        "兆康站": { "NR762": "豫豐花園", "NR762A": null }, 
                        "屯門市中心": { "NR762": null, "NR762A": "豫豐花園" },
                        "藍地站 (南行)": { "NR762": null, "NR762A": null },
                        "藍地站 (北行)": { "NR762": null, "NR762A": null },
                        "屯公轉車站 (屯門方向)": { "NR762": null, "NR762A": null },
                        "妙法寺": { "NR762": null, "NR762A": null },
                        "福亨村": { "NR762": null, "NR762A": null },
                        "紅橋": { "NR762": null, "NR762A": null },
                        "富泰邨": { "NR762": null, "NR762A": null },
                        "新墟街市": { "NR762": null, "NR762A": null },
                        "紅橋 (回家)": { "NR762": null, "NR762A": null },
                        "深圳灣口岸": { "NR762": null, "NR762A": null },
                        // --- RENAMED ---
                        "富泰邨 (北行)": { "NR762": null, "NR762A": null },
                        // --- END ---
                        "屯門公路轉車站": { "NR762": null, "NR762A": null } 
                    },
                    kmbConfigs: { /* ... KMB configs ... */ 
                        "屯門市中心": { stopId: 'F26CC0CB9587F2F9', subtitle: '由 屯門大會堂', targetRoutes: ['63X', '68A', '960P'] },
                        "屯公轉車站 (屯門方向)": { stopId: '872110C8ADA14DA1', subtitle: '由 屯公轉車站 (屯門方向)', targetRoutes: ['63X', '68A', '960P'] },
                        "藍地站 (北行)": { stopId: '7FE552E3792C9047', subtitle: '由 藍地站 (北行)' },
                        "藍地站 (南行)": { stopId: '46D1A9FD1F84CA5C', subtitle: '由 藍地站 (南行)' },
                        "妙法寺": { stopId: 'B64EEA7F564C7853', subtitle: '由 妙法寺' },
                        "福亨村": { stopId: 'D073CC71A1B4F79C', subtitle: '由 福亨村' },
                        "紅橋": [
                            { stopId: '210978D525EEDF4F', subtitle: '由 紅橋 (TM710)' },
                            { stopId: '8C32D9DDB85891A6', subtitle: '由 紅橋 (TM711)' },
                            { stopId: '6FB7BC1E5BC1E4EE', subtitle: '由 紅橋 (TM712)' },
                            { stopId: '2FD7EBBD4AF78A93', subtitle: '由 紅橋 (TM713)' },
                            { stopId: 'DD56DC2336C878C1', subtitle: '由 紅橋 (TM714)' }
                        ],
                        "富泰邨": [
                            { stopId: 'F1D1F84A466543BE', subtitle: '由 富泰邨' },
                            { stopId: '2B354AE312900DF1', subtitle: '由 嶺南大學' }
                        ],
                        "新墟街市": { stopId: '7AC6625D894BA101', subtitle: '由 新墟街市', targetRoutes: ['63X', '68A', '960P'] },
                        "紅橋 (回家)": { stopId: 'CBE54DB551C24A02', subtitle: '由 紅橋 (回家)', targetRoutes: ['63X', '68A', '960P'] },
                        "屯門公路轉車站": { stopId: '376C4835851621D4', subtitle: '由 屯門公路轉車站' },
                        // --- RENAMED & Subtitle Updated ---
                        "富泰邨 (北行)": { stopId: 'B954B8082D1AA9B0', subtitle: '由 富泰邨 (北行)', targetRoutes: ['261'] } 
                        // --- END ---
                    },
                    lwbConfigs: {
                        "富泰邨": { apiUrl: 'https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/CBCE32D56C5263A9', subtitle: '由 富泰邨 (龍運)' },
                        "藍地站 (南行)": { apiUrl: 'https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/29395B362BEDBA1E', subtitle: '由 藍地站 (龍運)' },
                        "福亨村": { apiUrl: 'https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/0CC3913BEF225E76', subtitle: '由 福亨村 (龍運)' },
                        "妙法寺": { apiUrl: 'https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/97A265C9E6F9AA61', subtitle: '由 妙法寺 (龍運)' }
                    },
                    lightRailConfig: { /* ... LRT configs ... */ 
                        "兆康站": { apiUrl: 'https://rt.data.gov.hk/v1/transport/mtr/lrt/getSchedule?station_id=100', targetPlatform: 1, subtitle: '往元朗/天逸' },
                        "藍地站 (北行)": { apiUrl: 'https://rt.data.gov.hk/v1/transport/mtr/lrt/getSchedule?station_id=350', targetPlatform: 1, subtitle: '往元朗/天逸' },
                        "藍地站 (南行)": { apiUrl: 'https://rt.data.gov.hk/v1/transport/mtr/lrt/getSchedule?station_id=350', targetPlatform: 2, subtitle: '往屯門碼頭/友愛' },
                        "屯門市中心": { apiUrl: 'https://rt.data.gov.hk/v1/transport/mtr/lrt/getSchedule?station_id=280', targetPlatform: 1, subtitle: '往元朗/天逸', filterRoutes: ['614', '614P', '751'] }
                    },
                    nlbConfig: { /* ... NLB configs ... */ 
                         "藍地站 (南行)": { 
                            apiUrl: 'https://rt.data.gov.hk/v2/transport/nlb/stop.php?action=estimatedArrivals&routeId=37&stopId=151&language=zh',
                            routeNo: 'B2',
                            destination: '深圳灣口岸',
                            subtitle: '由 藍地站 (南行)'
                        },
                        "深圳灣口岸": {
                            apiUrl: 'https://rt.data.gov.hk/v2/transport/nlb/stop.php?action=estimatedArrivals&routeId=38&stopId=152&language=zh',
                            routeNo: 'B2',
                            destination: '元朗',
                            subtitle: '由 深圳灣口岸'
                        }
                    },
                    ctbConfig: { /* ... CTB configs ... */ 
                         "深圳灣口岸": {
                            apiUrl: 'https://rt.data.gov.hk/v2/transport/citybus/eta/ctb/003208/b3a',
                            routeNo: 'B3A',
                            destination: '山景邨',
                            subtitle: '由 深圳灣口岸'
                        },
                         // --- RENAMED & Subtitle Updated ---
                         "富泰邨 (北行)": {
                            apiUrl: 'https://rt.data.gov.hk/v2/transport/citybus/eta/ctb/003261/b3a',
                            routeNo: 'B3A',
                            destination: '深圳灣口岸', 
                            subtitle: '由 富泰邨 (北行)'
                        }
                         // --- END ---
                    },
                    // --- Define CORS Proxy URL (used only for NLB, CTB if direct fails) ---
                    // corsProxyUrl: 'https://thingproxy.freeboard.io/fetch/' 
                    // No proxy seems to work best for now. Add back if needed.
                },

                // 3. ELEMENTS
                elements: {},

                /**
                 * 4. INIT
                 */
                init() {
                    this.elements = {
                        etaView: document.getElementById('etaView'),
                        timetableView: document.getElementById('timetableView'),
                        locationSelector: document.getElementById('locationSelector'),
                        geolocationMessage: document.getElementById('geolocationMessage'),
                        departuresDisplay: document.getElementById('departuresDisplay'),
                        lightRailSection: document.getElementById('lightRailSection'),
                        lightRailSubtitle: document.getElementById('lightRailSubtitle'),
                        lightRailDepartures: document.getElementById('lightRailDepartures'),
                        lightRailMessage: document.getElementById('lightRailMessage'),
                        kmbSection: document.getElementById('kmbSection'),
                        kmbSubtitle: document.getElementById('kmbSubtitle'),
                        kmbDepartures: document.getElementById('kmbDepartures'),
                        kmbMessage: document.getElementById('kmbMessage'),
                        lwbSection: document.getElementById('lwbSection'),
                        lwbSubtitle: document.getElementById('lwbSubtitle'),
                        lwbDepartures: document.getElementById('lwbDepartures'),
                        lwbMessage: document.getElementById('lwbMessage'),
                        nlbSection: document.getElementById('nlbSection'),
                        nlbSubtitle: document.getElementById('nlbSubtitle'),
                        nlbDepartures: document.getElementById('nlbDepartures'),
                        nlbMessage: document.getElementById('nlbMessage'),
                        ctbSection: document.getElementById('ctbSection'),
                        ctbSubtitle: document.getElementById('ctbSubtitle'),
                        ctbDepartures: document.getElementById('ctbDepartures'),
                        ctbMessage: document.getElementById('ctbMessage'),
                        nr762Section: document.getElementById('nr762Section'),
                        nr762Route: document.getElementById('nr762Route'),
                        nr762Departures: document.getElementById('nr762Departures'),
                        nr762Message: document.getElementById('nr762Message'),
                        nr762aSection: document.getElementById('nr762aSection'),
                        nr762aRoute: document.getElementById('nr762aRoute'),
                        nr762aDepartures: document.getElementById('nr762aDepartures'),
                        nr762aMessage: document.getElementById('nr762aMessage'),
                        bottomNavOutButton: document.getElementById('bottomNavOutButton'),
                        bottomNavHomeButton: document.getElementById('bottomNavHomeButton'),
                        bottomNavTimetableButton: document.getElementById('bottomNavTimetableButton'),
                        nr762SubTabButton: document.getElementById('nr762SubTabButton'),
                        nr762aSubTabButton: document.getElementById('nr762aSubTabButton'),
                        timetableContentNR762: document.getElementById('timetableContentNR762'),
                        timetableContentNR762A: document.getElementById('timetableContentNR762A'),
                        nr762RichwoodContainer: document.getElementById('nr762_richwood_timetable_container'),
                        nr762SiuhongContainer: document.getElementById('nr762_siuhong_timetable_container'),
                        nr762aRichwoodContainer: document.getElementById('nr762a_richwood_timetable_container'),
                        nr762aTuenmunContainer: document.getElementById('nr762a_tuenmun_timetable_container'),
                        refreshButton: document.getElementById('refreshButton'),
                        ptrIndicator: document.getElementById('pullToRefreshIndicator'),
                        ptrSpinner: document.getElementById('pullRefreshSpinner'),
                        ptrTextEl: document.getElementById('pullRefreshText'),
                    };

                    this.setupEventListeners();
                    this.handleDetectLocation(); 
                },

                /**
                 * 5. EVENT LISTENERS
                 */
                setupEventListeners() {
                    this.elements.bottomNavOutButton.addEventListener('click', () => this.handleMainTabClick('out'));
                    this.elements.bottomNavHomeButton.addEventListener('click', () => this.handleMainTabClick('home'));
                    this.elements.bottomNavTimetableButton.addEventListener('click', () => this.handleMainTabClick('timetable'));
                    this.elements.locationSelector.addEventListener('click', this.handleLocationSelect.bind(this));
                    this.elements.nr762SubTabButton.addEventListener('click', () => this.showTimetableSubView('timetableContentNR762'));
                    this.elements.nr762aSubTabButton.addEventListener('click', () => this.showTimetableSubView('timetableContentNR762A'));
                    this.elements.refreshButton.addEventListener('click', this.handleRefresh.bind(this));
                    document.body.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: true });
                    document.body.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
                    document.body.addEventListener('touchend', this.handleTouchEnd.bind(this));
                },

                // 6. VIEW/UI LOGIC
                
                handleMainTabClick(viewOrDirection) { /* ... same as before ... */ 
                    if (viewOrDirection === 'timetable') {
                        this.state.currentView = 'timetableView';
                        this.showView('timetableView');
                        this.renderFullTimetables();
                        this.showTimetableSubView('timetableContentNR762'); 
                    } else {
                        this.state.currentView = 'etaView';
                        this.state.currentDirection = viewOrDirection;
                        this.showView('etaView');
                        this.populateLocationSelector();
                        
                        const firstLocationButton = this.elements.locationSelector.querySelector('button');
                        if (firstLocationButton) {
                            this.selectLocationButton(firstLocationButton);
                        }
                    }
                    this.updateBottomNavUI();
                },

                showView(viewId) { /* ... same as before ... */ 
                    this.elements.etaView.classList.toggle('hidden', viewId !== 'etaView');
                    this.elements.timetableView.classList.toggle('hidden', viewId !== 'timetableView');
                    
                    if (viewId === 'etaView') {
                        this.elements.geolocationMessage.classList.add('hidden');
                    } else {
                        if (this.state.countdownIntervalId) {
                            clearInterval(this.state.countdownIntervalId);
                            this.state.countdownIntervalId = null;
                        }
                    }
                },
                
                updateBottomNavUI() { /* ... same as before ... */ 
                    const { currentView, currentDirection } = this.state;
                    this.elements.bottomNavOutButton.classList.toggle('selected', currentView === 'etaView' && currentDirection === 'out');
                    this.elements.bottomNavHomeButton.classList.toggle('selected', currentView === 'etaView' && currentDirection === 'home');
                    this.elements.bottomNavTimetableButton.classList.toggle('selected', currentView === 'timetableView');
                },

                populateLocationSelector() {
                    const currentLocations = this.config.locations[this.state.currentDirection] || [];
                    this.elements.locationSelector.innerHTML = ''; 

                    if (this.state.currentDirection === 'out') {
                        const groupConfigs = [
                            { 
                                title: "市區方向: (南行)", 
                                rows: [
                                    ["豫豐花園", "藍地站 (南行)", "紅橋"],
                                    ["福亨村", "妙法寺", "富泰邨", "屯門公路轉車站"] 
                                ] 
                            },
                            { 
                                title: "元朗方向: (北行)", 
                                rows: [
                                     // --- RENAMED ---
                                    ["藍地站 (北行)", "富泰邨 (北行)"] 
                                     // --- END ---
                                ]
                            }
                        ];
                        const allOutLocations = this.config.locations.out.reduce((acc, loc) => {
                            acc[loc.name] = loc;
                            return acc;
                        }, {});
                        
                        groupConfigs.forEach(groupConfig => {
                            const titleEl = document.createElement('h3');
                            titleEl.className = 'text-md font-semibold text-slate-700 text-left'; 
                            titleEl.textContent = groupConfig.title;
                            this.elements.locationSelector.appendChild(titleEl);

                            groupConfig.rows.forEach(rowLocations => {
                                const buttonRowDiv = document.createElement('div');
                                buttonRowDiv.className = 'flex flex-wrap gap-2 justify-center'; 
                                
                                rowLocations.forEach(locName => {
                                    const loc = allOutLocations[locName];
                                    if (loc) {
                                        const button = document.createElement('button');
                                        button.className = 'px-3 py-1.5 rounded-full font-medium text-sm';
                                        button.textContent = loc.displayName || loc.name;
                                        button.value = loc.name; 
                                        buttonRowDiv.appendChild(button);
                                    }
                                });
                                this.elements.locationSelector.appendChild(buttonRowDiv);
                            });
                        });

                    } else {
                         /* ... home tab logic remains same ... */
                        const rowDiv = document.createElement('div');
                        rowDiv.className = 'flex flex-wrap gap-2 justify-center';
                        
                        currentLocations.forEach(loc => {
                            const button = document.createElement('button');
                            button.className = 'px-3 py-1.5 rounded-full font-medium text-sm';
                            button.textContent = loc.displayName || loc.name;
                            button.value = loc.name; 
                            rowDiv.appendChild(button);
                        });
                        this.elements.locationSelector.appendChild(rowDiv);
                    }
                },

                showTimetableSubView(subViewId) { /* ... same as before ... */ 
                    [this.elements.timetableContentNR762, this.elements.timetableContentNR762A].forEach(view => {
                        view.classList.toggle('hidden', view.id !== subViewId);
                    });
                    this.elements.nr762SubTabButton.classList.toggle('selected', subViewId === 'timetableContentNR762');
                    this.elements.nr762aSubTabButton.classList.toggle('selected', subViewId === 'timetableContentNR762A');
                },
                
                handleLocationSelect(e) { /* ... same as before ... */ 
                    const button = e.target.closest('button');
                    if (button && !button.classList.contains('selected')) {
                        this.selectLocationButton(button);
                    }
                },

                selectLocationButton(buttonEl) { /* ... same as before ... */ 
                    if (!buttonEl || this.state.isRefreshing) return; 

                    this.elements.locationSelector.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
                    buttonEl.classList.add('selected');
                    this.state.currentLocationName = buttonEl.value;
                    this.displayDepartures();
                },

                // 7. DATA FETCHING & RENDERING

                async displayDepartures() { 
                    if (this.state.isRefreshing) return; 
                    this.state.isRefreshing = true;
                    this.elements.refreshButton.disabled = true;
                    this.elements.refreshButton.textContent = '更新中...';

                    const locationName = this.state.currentLocationName;
                    if (!locationName) {
                        this.state.isRefreshing = false; 
                        this.elements.refreshButton.disabled = false;
                        this.elements.refreshButton.textContent = '刷新班次';
                        return;
                    }

                    if (this.state.countdownIntervalId) {
                        clearInterval(this.state.countdownIntervalId);
                        this.state.countdownIntervalId = null;
                    }
                    
                    this.setCardOrder(locationName);
                    
                    [this.elements.kmbSection, this.elements.lwbSection, this.elements.lightRailSection, this.elements.nlbSection, this.elements.ctbSection, this.elements.nr762Section, this.elements.nr762aSection].forEach(s => s.classList.add('hidden'));

                    const now = this.utils.getCurrentHktTime();

                    const displayPromises = [
                        this.updateShuttleSection('NR762', locationName, now),
                        this.updateShuttleSection('NR762A', locationName, now)
                    ];

                    const kmbConfig = this.config.kmbConfigs[locationName];
                    if (kmbConfig) displayPromises.push(this.updateKmbSection(kmbConfig, locationName));
                    
                    const lwbConfig = this.config.lwbConfigs[locationName];
                    if (lwbConfig) displayPromises.push(this.updateLwbSection(lwbConfig, locationName)); 

                    const lrtConfig = this.config.lightRailConfig[locationName];
                    if (lrtConfig) displayPromises.push(this.updateLightRailSection(lrtConfig));
                    
                    const nlbConfig = this.config.nlbConfig[locationName];
                    if (nlbConfig) displayPromises.push(this.updateNlbSection(nlbConfig));

                    const ctbConfig = this.config.ctbConfig[locationName];
                    if (ctbConfig) displayPromises.push(this.updateCtbSection(ctbConfig));

                    await Promise.all(displayPromises);
                    
                    this.updateAllCountdowns(); 
                    if (document.querySelector('#etaView li[data-departure-time]')) {
                        this.state.countdownIntervalId = setInterval(this.updateAllCountdowns.bind(this), 1000);
                    }

                    setTimeout(() => {
                        this.state.isRefreshing = false;
                        if (this.elements.refreshButton) {
                            this.elements.refreshButton.disabled = false;
                            this.elements.refreshButton.textContent = '刷新班次';
                        }
                    }, 800); 
                },

                setCardOrder(locationName) {
                    const { nr762Section, nr762aSection, kmbSection, lwbSection, lightRailSection, nlbSection, ctbSection } = this.elements;
                    let order = { nr762: 1, nr762a: 2, kmb: 3, lwb: 4, lrt: 5, nlb: 6, ctb: 7 }; 

                    if (locationName === '屯門市中心') {
                        order = { nr762a: 1, kmb: 2, lrt: 3, nr762: 4, lwb: 5, nlb: 6, ctb: 7 };
                    } else if (locationName === '藍地站 (南行)') {
                        order = { nr762: 1, nr762a: 2, kmb: 3, lwb: 4, lrt: 5, nlb: 6, ctb: 7 }; 
                    } else if (locationName === '深圳灣口岸') { 
                         order = { nlb: 1, ctb: 2, nr762: 3, nr762a: 4, kmb: 5, lwb: 6, lrt: 7 }; 
                    // --- RENAMED ---
                    } else if (locationName === '富泰邨 (北行)') { 
                    // --- END ---
                         order = { ctb: 1, kmb: 2, nr762: 3, nr762a: 4, lwb: 5, lrt: 6, nlb: 7 }; 
                    } else if (locationName === '屯門公路轉車站') {
                         order = { kmb: 1, nr762: 2, nr762a: 3, lwb: 4, lrt: 5, nlb: 6, ctb: 7 }; 
                    } else if (locationName === '富泰邨' || locationName === '福亨村' || locationName === '妙法寺') {
                        order = { nr762: 1, nr762a: 2, kmb: 3, lwb: 4, lrt: 5, nlb: 6, ctb: 7 }; 
                    }
                    
                    nr762Section.style.order = order.nr762;
                    nr762aSection.style.order = order.nr762a;
                    kmbSection.style.order = order.kmb;
                    lwbSection.style.order = order.lwb; 
                    lightRailSection.style.order = order.lrt;
                    nlbSection.style.order = order.nlb;
                    ctbSection.style.order = order.ctb; 
                },

                 updateShuttleSection(routeId, locationName, now) { /* ... same as before ... */ 
                    const lowerRouteId = routeId.toLowerCase();
                    const section = this.elements[`${lowerRouteId}Section`];
                    const departuresEl = this.elements[`${lowerRouteId}Departures`];
                    const messageEl = this.elements[`${lowerRouteId}Message`];
                    const routeEl = this.elements[`${lowerRouteId}Route`];
                    
                    departuresEl.innerHTML = '';
                    messageEl.textContent = '';
                    
                    const destName = (this.state.currentDirection === 'out') 
                        ? this.config.destinations[locationName]?.[routeId] 
                        : '豫豐花園';
                    
                    const internalLocationName = Object.values(this.config.locations).flat().find(loc => loc.name === locationName)?.name || locationName; 
                    const scheduleKeyName = (this.state.currentDirection === 'out')
                        ? `${internalLocationName}_to_${destName}`
                        : `${internalLocationName}_to_豫豐花園`;
                    
                    const schedule = this.config.allSchedules[routeId]?.[scheduleKeyName];

                    if (destName && schedule) {
                        section.classList.remove('hidden');
                        const displayLocationName = this.config.locations[this.state.currentDirection].find(loc => loc.name === locationName)?.displayName || locationName;
                        routeEl.textContent = `由 ${displayLocationName} 開往 ${destName}`;
                        const departures = this.utils.getUpcomingDepartures(schedule, now.hour, now.minute, 5);
                        
                        if (departures.length > 0) {
                            departures.forEach((dep, index) => {
                                const li = document.createElement('li');
                                const styleClass = routeId === 'NR762' ? 'bg-indigo-50' : 'bg-teal-50';
                                li.className = `p-3 ${styleClass} rounded-md shadow-sm flex justify-between items-center transition-opacity`;
                                if (index === 0) li.classList.add('next-departure-highlight');
                                li.dataset.departureTime = dep.date.toISOString();
                                li.innerHTML = `<span>${this.utils.formatDepartureTime(dep.hour, dep.minute)}</span><span class="countdown-text ml-2"></span>`;
                                departuresEl.appendChild(li);
                            });
                        } else {
                            messageEl.textContent = '今日已無班次。';
                        }
                    } else {
                        section.classList.add('hidden');
                    }
                },
                
                async updateKmbSection(kmbConfig, locationName) { 
                    const { kmbSection, kmbDepartures, kmbMessage, kmbSubtitle } = this.elements;
                    
                    kmbDepartures.innerHTML = '';
                    kmbMessage.textContent = '';
                    kmbSection.classList.remove('hidden');
                    const displayLocationName = this.config.locations[this.state.currentDirection].find(loc => loc.name === locationName)?.displayName || locationName;

                    if (Array.isArray(kmbConfig)) {
                        let combined = false;
                        let subtitleText = `${displayLocationName} 巴士站`; 

                        if (locationName === "富泰邨") {
                            subtitleText = "由 富泰邨"; 
                            combined = true;
                        } else if (locationName === "紅橋") {
                             subtitleText = `由 ${displayLocationName}`; 
                             combined = true;
                        } 
                        
                        kmbSubtitle.textContent = subtitleText;
                        kmbDepartures.innerHTML = combined ? '<li class="text-gray-500">正在載入九巴班次...</li>' : ''; 

                        try {
                            const fetchPromises = kmbConfig.map(stop => this.fetchKmbData(stop.stopId));
                            const results = await Promise.all(fetchPromises);
                            
                            if(combined) {
                                const combinedData = { data: [] };
                                results.forEach(result => {
                                    if (result && result.data) {
                                        combinedData.data.push(...result.data);
                                    }
                                });
                                const dummyConfig = { targetRoutes: null }; 
                                this.renderKmbDepartures(combinedData, dummyConfig, kmbDepartures, kmbMessage, locationName); 
                            } else {
                                results.forEach((data, index) => {
                                    const stopConfig = kmbConfig[index];
                                    const subSectionEl = document.createElement('div');
                                    subSectionEl.className = 'mt-4';
                                    if (index > 0) subSectionEl.className += ' pt-4 border-t border-gray-300 border-opacity-50';
                                    
                                    const subTitle = document.createElement('h4');
                                    subTitle.className = 'text-lg font-semibold text-gray-800 mb-2';
                                    subTitle.textContent = stopConfig.subtitle;
                                    const subListEl = document.createElement('ul');
                                    subListEl.className = 'space-y-2';
                                    const subMessageEl = document.createElement('p');
                                    subMessageEl.className = 'mt-3 text-sm';
                                    
                                    subSectionEl.appendChild(subTitle);
                                    subSectionEl.appendChild(subListEl);
                                    subSectionEl.appendChild(subMessageEl);
                                    
                                    this.renderKmbDepartures(data, stopConfig, subListEl, subMessageEl, locationName);
                                    kmbDepartures.appendChild(subSectionEl);
                                });
                            }
                        } catch (error) {
                            console.error(`KMB Fetch Error for ${locationName}:`, error);
                            kmbDepartures.innerHTML = '';
                            kmbMessage.textContent = '無法載入九巴班次，請稍後再試。';
                        }
                    } else {
                        // Logic for single stops 
                        kmbSubtitle.textContent = kmbConfig.subtitle; 
                        kmbDepartures.innerHTML = '<li class="text-gray-500">正在載入九巴班次...</li>';
                        try {
                            const data = await this.fetchKmbData(kmbConfig.stopId);
                            this.renderKmbDepartures(data, kmbConfig, kmbDepartures, kmbMessage, locationName); 
                        } catch (error) {
                            console.error("KMB Fetch Error:", error);
                            kmbDepartures.innerHTML = '';
                            kmbMessage.textContent = '無法載入九巴班次，請稍後再試。';
                        }
                    }
                },
                
                async fetchKmbData(stopId) { 
                    const apiUrl = `https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/${stopId}`;
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    return await response.json();
                },

                renderKmbDepartures(data, kmbConfig, listElement, messageElement, locationName) { 
                    listElement.innerHTML = ''; 
                    
                    let relevantDepartures = (data && data.data) ? data.data : []; 
                    relevantDepartures = relevantDepartures
                        .filter(bus => bus.eta)
                        .sort((a, b) => new Date(a.eta) - new Date(b.eta));
                    
                    if (kmbConfig.targetRoutes) {
                        relevantDepartures = relevantDepartures.filter(bus => kmbConfig.targetRoutes.includes(bus.route));
                    }

                    const uniqueDepartures = [];
                    const seenDepartures = new Set();
                    
                    for (const dep of relevantDepartures) {
                        const key = `${dep.route}|${dep.dest_tc}|${dep.eta}`;
                        if (!seenDepartures.has(key)) {
                            seenDepartures.add(key);
                            uniqueDepartures.push(dep);
                        }
                    }

                    if (uniqueDepartures.length > 0) {
                        let limit = 5; 
                        if (locationName === "紅橋") { 
                           limit = 30; 
                        } else if (locationName === "屯門公路轉車站") {
                           limit = 40; 
                        } else if (locationName && (locationName.includes("藍地站") || locationName === "富泰邨" || locationName === "紅橋 (回家)" || locationName === "新墟街市")) { 
                           limit = 10; 
                        } else if (kmbConfig && Array.isArray(this.config.kmbConfigs[locationName]) && locationName !== "富泰邨" && locationName !== "紅橋") {
                           limit = 10; 
                        }
                        
                        uniqueDepartures.slice(0, limit).forEach((dep, index) => {
                            const li = document.createElement('li');
                            li.className = 'p-3 bg-green-50 rounded-md shadow-sm flex justify-between items-center transition-opacity';
                            if (index === 0) li.classList.add('next-departure-highlight', 'next-departure-highlight-green');
                            li.dataset.departureTime = dep.eta;
                            
                            const timeText = document.createElement('span');
                            timeText.innerHTML = `<span class="font-bold text-lg">${dep.route}</span> <span class="text-gray-600">往 ${dep.dest_tc}</span>`;
                            
                            const countdownSpan = document.createElement('span');
                            countdownSpan.className = 'countdown-text ml-2';
                            
                            li.appendChild(timeText);
                            li.appendChild(countdownSpan);
                            listElement.appendChild(li);
                        });
                    } else {
                        messageElement.textContent = '暫無相關九巴班次資料。';
                    }
                },

                // --- NEW LWB Functions ---
                async updateLwbSection(lwbConfig, locationName) { 
                    const { lwbSection, lwbDepartures, lwbMessage, lwbSubtitle } = this.elements;
                    
                    lwbDepartures.innerHTML = '';
                    lwbMessage.textContent = '';
                    lwbSection.classList.remove('hidden');
                    lwbSubtitle.textContent = lwbConfig.subtitle; 
                    lwbDepartures.innerHTML = '<li class="text-gray-500">正在載入龍運班次...</li>';

                    try {
                        const data = await this.fetchLwbData(lwbConfig.apiUrl); 
                        this.renderLwbDepartures(data, lwbConfig, lwbDepartures, lwbMessage, locationName); 
                    } catch (error) {
                        console.error("LWB Fetch Error:", error);
                        lwbDepartures.innerHTML = '';
                        lwbMessage.textContent = '無法載入龍運班次，請稍後再試。';
                    }
                },

                async fetchLwbData(apiUrl) { 
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    return await response.json();
                },

                renderLwbDepartures(data, lwbConfig, listElement, messageElement, locationName) { 
                    listElement.innerHTML = ''; 
                    
                    let relevantDepartures = (data && data.data) ? data.data : []; 
                    relevantDepartures = relevantDepartures
                        .filter(bus => bus.eta)
                        .sort((a, b) => new Date(a.eta) - new Date(b.eta));
                    
                    const uniqueDepartures = [];
                    const seenDepartures = new Set();
                    
                    for (const dep of relevantDepartures) {
                        const key = `${dep.route}|${dep.dest_tc}|${dep.eta}`;
                        if (!seenDepartures.has(key)) {
                            seenDepartures.add(key);
                            uniqueDepartures.push(dep);
                        }
                    }

                    if (uniqueDepartures.length > 0) {
                        let limit = 5; 
                        if (locationName && (locationName.includes("藍地站") || locationName === "富泰邨" || locationName === "福亨村" || locationName === "妙法寺")) {
                           limit = 10; 
                        } 
                        
                        uniqueDepartures.slice(0, limit).forEach((dep, index) => {
                            const li = document.createElement('li');
                            li.className = 'p-3 bg-purple-50 rounded-md shadow-sm flex justify-between items-center transition-opacity';
                            if (index === 0) li.classList.add('next-departure-highlight', 'next-departure-highlight-purple');
                            li.dataset.departureTime = dep.eta;
                            
                            const timeText = document.createElement('span');
                            timeText.innerHTML = `<span class="font-bold text-lg">${dep.route}</span> <span class="text-gray-600">往 ${dep.dest_tc}</span>`;
                            
                            const countdownSpan = document.createElement('span');
                            countdownSpan.className = 'countdown-text ml-2';
                            
                            li.appendChild(timeText);
                            li.appendChild(countdownSpan);
                            listElement.appendChild(li);
                        });
                    } else {
                        messageElement.textContent = '暫無相關龍運班次資料。';
                    }
                },
                // --- END LWB Functions ---

                async updateLightRailSection(lrtConfig) { /* ... NO PROXY ... */ 
                    const { lightRailSection, lightRailDepartures, lightRailMessage, lightRailSubtitle } = this.elements;

                    lightRailDepartures.innerHTML = '<li class="text-gray-500">正在載入輕鐵班次...</li>';
                    lightRailMessage.textContent = '';
                    lightRailSubtitle.textContent = lrtConfig.subtitle;
                    lightRailSection.classList.remove('hidden');

                    try {
                        const response = await fetch(lrtConfig.apiUrl); 
                        if (!response.ok) throw new Error(`API error: ${response.status}`);
                        const data = await response.json();
                        lightRailDepartures.innerHTML = '';

                        let platform = data.platform_list.find(p => p.platform_id === lrtConfig.targetPlatform);
                        
                        if (platform && platform.route_list && platform.route_list.length > 0) {
                            let relevantDepartures = platform.route_list.filter(route => route.time_ch);

                            if (lrtConfig.filterRoutes) {
                                relevantDepartures = relevantDepartures.filter(route => lrtConfig.filterRoutes.includes(route.route_no));
                            }

                            if (relevantDepartures.length > 0) {
                                relevantDepartures.forEach((dep, index) => {
                                    const li = document.createElement('li');
                                    li.className = 'p-3 bg-yellow-50 rounded-md flex justify-between items-center';
                                    if (index === 0) li.classList.add('next-departure-highlight', 'next-departure-highlight-yellow');
                                    
                                    const leftDiv = document.createElement('div');
                                    leftDiv.className = 'flex-grow';
                                    leftDiv.innerHTML = `<span class="font-bold text-lg">${dep.route_no}</span> <span class="text-gray-600">往 ${dep.dest_ch}</span>`;
                                    
                                    const rightDiv = document.createElement('div');
                                    rightDiv.className = 'flex items-center flex-shrink-0 ml-4';

                                    const carCountSpan = document.createElement('span');
                                    carCountSpan.className = 'font-medium text-gray-600 w-14 text-center';
                                    carCountSpan.textContent = dep.train_length === 1 ? '🚃' : '🚃 🚃';

                                    const etaSpan = document.createElement('span');
                                    etaSpan.className = 'font-medium w-28 text-right';
                                    
                                    if (dep.time_ch === "-") {
                                        etaSpan.textContent = "即將到達/已開出";
                                        etaSpan.className += ' text-gray-500';
                                    } else {
                                        etaSpan.textContent = dep.time_ch;
                                        etaSpan.className += ' text-yellow-700';
                                    }

                                    rightDiv.appendChild(carCountSpan);
                                    rightDiv.appendChild(etaSpan);
                                    
                                    li.appendChild(leftDiv);
                                    li.appendChild(rightDiv);
                                    lightRailDepartures.appendChild(li);
                                });
                            } else {
                                lightRailMessage.textContent = '暫無相關輕鐵班次資料。';
                            }
                        } else {
                            lightRailMessage.textContent = '暫無輕鐵班次資料。';
                        }
                    } catch (error) {
                        console.error("LRT Fetch Error:", error);
                        lightRailDepartures.innerHTML = '';
                        lightRailMessage.textContent = '無法載入輕鐵班次，請稍後再試。';
                    }
                },

                async updateNlbSection(nlbConfig) { 
                    const { nlbSection, nlbDepartures, nlbMessage, nlbSubtitle } = this.elements;

                    nlbDepartures.innerHTML = '<li class="text-gray-500">正在載入嶼巴班次...</li>';
                    nlbMessage.textContent = '';
                    nlbSubtitle.textContent = nlbConfig.subtitle;
                    nlbSection.classList.remove('hidden');

                    try {
                        const response = await fetch(nlbConfig.apiUrl);
                        if (!response.ok) throw new Error(`API error: ${response.status}`);
                        const data = await response.json();
                        nlbDepartures.innerHTML = '';

                        if (data.estimatedArrivals && data.estimatedArrivals.length > 0) {
                            const upcomingArrivals = data.estimatedArrivals
                                .sort((a, b) => new Date(a.estimatedArrivalTime) - new Date(b.estimatedArrivalTime));

                            if (upcomingArrivals.length > 0) {
                                upcomingArrivals.forEach((dep, index) => {
                                    const li = document.createElement('li');
                                    li.className = 'p-3 bg-blue-50 rounded-md shadow-sm flex justify-between items-center transition-opacity'; 
                                    if (index === 0) li.classList.add('next-departure-highlight', 'next-departure-highlight-blue');
                                    
                                    const hktDepartureString = dep.estimatedArrivalTime.replace(' ', 'T') + '+08:00'; 
                                    li.dataset.departureTime = hktDepartureString; 

                                    const timeText = document.createElement('span');
                                    timeText.innerHTML = `<span class="font-bold text-lg">${nlbConfig.routeNo}</span> <span class="text-gray-600">往 ${nlbConfig.destination}</span>`;

                                    const countdownSpan = document.createElement('span');
                                    countdownSpan.className = 'countdown-text ml-2';

                                    li.appendChild(timeText);
                                    li.appendChild(countdownSpan);
                                    nlbDepartures.appendChild(li);
                                });
                            } else {
                                nlbMessage.textContent = '暫無相關嶼巴班次資料。';
                            }
                        } else {
                            nlbMessage.textContent = '暫無嶼巴班次資料。';
                        }
                    } catch (error) {
                        console.error("NLB Fetch Error:", error);
                        nlbDepartures.innerHTML = '';
                        nlbMessage.textContent = '無法載入嶼巴班次，請稍後再試。';
                    }
                },

                async updateCtbSection(ctbConfig) { 
                    const { ctbSection, ctbDepartures, ctbMessage, ctbSubtitle } = this.elements;

                    ctbDepartures.innerHTML = '<li class="text-gray-500">正在載入城巴班次...</li>';
                    ctbMessage.textContent = '';
                    ctbSubtitle.textContent = ctbConfig.subtitle;
                    ctbSection.classList.remove('hidden');

                    try {
                        const response = await fetch(ctbConfig.apiUrl);
                        if (!response.ok) throw new Error(`API error: ${response.status}`);
                        const data = await response.json();
                        ctbDepartures.innerHTML = '';

                        if (data.data && data.data.length > 0) {
                            const upcomingArrivals = data.data
                                .filter(arrival => !ctbConfig.destination || arrival.dest_tc === ctbConfig.destination) 
                                .sort((a, b) => new Date(a.eta) - new Date(b.eta));

                            if (upcomingArrivals.length > 0) {
                                upcomingArrivals.forEach((dep, index) => {
                                    const li = document.createElement('li');
                                    li.className = 'p-3 bg-orange-50 rounded-md shadow-sm flex justify-between items-center transition-opacity'; 
                                    if (index === 0) li.classList.add('next-departure-highlight', 'next-departure-highlight-orange');
                                    
                                    li.dataset.departureTime = dep.eta; 

                                    const timeText = document.createElement('span');
                                    const destinationText = dep.dest_tc || ctbConfig.destination; 
                                    timeText.innerHTML = `<span class="font-bold text-lg">${ctbConfig.routeNo}</span> <span class="text-gray-600">往 ${destinationText}</span>`;

                                    const countdownSpan = document.createElement('span');
                                    countdownSpan.className = 'countdown-text ml-2';

                                    li.appendChild(timeText);
                                    li.appendChild(countdownSpan);
                                    ctbDepartures.appendChild(li);
                                });
                            } else {
                                ctbMessage.textContent = '暫無相關城巴班次資料。';
                            }
                        } else {
                            ctbMessage.textContent = '暫無城巴班次資料。';
                        }
                    } catch (error) {
                        console.error("CTB Fetch Error:", error);
                        ctbDepartures.innerHTML = '';
                        ctbMessage.textContent = '無法載入城巴班次，請稍後再試。';
                    }
                },

                updateAllCountdowns() { /* ... same as before ... */ 
                    const now = new Date();
                    document.querySelectorAll('li[data-departure-time]').forEach(li => {
                        const departureTimeString = li.dataset.departureTime;
                        let departureTime;
                        try {
                           departureTime = new Date(departureTimeString); 
                           if (isNaN(departureTime.getTime())) throw new Error("Invalid date format");
                        } catch (e) {
                           console.warn("Could not parse date:", departureTimeString, e);
                           const countdownSpan = li.querySelector('.countdown-text, .departed-text');
                           if(countdownSpan) countdownSpan.textContent = "時間錯誤";
                           return; 
                        }

                        const diff = departureTime - now; 
                        const countdownSpan = li.querySelector('.countdown-text, .departed-text'); 

                        if (countdownSpan) { 
                            const totalSeconds = Math.floor(diff / 1000);
                            
                            if (totalSeconds < -60) {
                                countdownSpan.textContent = "已開出";
                                countdownSpan.classList.remove('countdown-text'); 
                                countdownSpan.classList.add('departed-text');
                                li.style.opacity = '0.5';
                            } else if (totalSeconds < 0) {
                                countdownSpan.textContent = "即將開出";
                                 countdownSpan.classList.remove('departed-text');
                                countdownSpan.classList.add('countdown-text');
                                li.style.opacity = '1'; 
                            } else { 
                                const displayMinutes = Math.floor(totalSeconds / 60);
                                const displaySeconds = totalSeconds % 60;
                                countdownSpan.textContent = `${String(displayMinutes).padStart(2, '0')} 分 ${String(displaySeconds).padStart(2, '0')} 秒`;
                                countdownSpan.classList.remove('departed-text'); 
                                countdownSpan.classList.add('countdown-text'); 
                                li.style.opacity = '1'; 
                            }
                        }
                    });
                },
                
                renderFullTimetables() { /* ... same as before ... */ 
                    const now = this.utils.getCurrentHktTime();
                    this.elements.nr762RichwoodContainer.innerHTML = this.generateTimetableTableHTML(this.config.allSchedules.NR762["豫豐花園_to_兆康站"], now);
                    this.elements.nr762SiuhongContainer.innerHTML = this.generateTimetableTableHTML(this.config.allSchedules.NR762["兆康站_to_豫豐花園"], now);
                    this.elements.nr762aRichwoodContainer.innerHTML = this.generateTimetableTableHTML(this.config.allSchedules.NR762A["豫豐花園_to_屯門市中心"], now);
                    this.elements.nr762aTuenmunContainer.innerHTML = this.generateTimetableTableHTML(this.config.allSchedules.NR762A["屯門市中心_to_豫豐花園"], now);
                },

                generateTimetableTableHTML(scheduleData, now) { /* ... same as before ... */ 
                    const nextGlobalDep = this.utils.findNextGlobalDeparture(scheduleData, now.hour, now.minute);
                    let tableHTML = '<table class="timetable-table"><thead><tr><th class="w-1/4">小時</th><th>分鐘</th></tr></thead><tbody>';

                    for (let hour = 6; hour < 24; hour++) { 
                        if (!scheduleData || !scheduleData[hour]) continue; 
                        const minutes = scheduleData[hour]; 
                        const hourStr = String(hour).padStart(2, '0');
                        const hourClass = (nextGlobalDep && hour === nextGlobalDep.hour) ? 'timetable-highlight-hour' : '';
                        const minuteToHighlight = (nextGlobalDep && hour === nextGlobalDep.hour) ? nextGlobalDep.minute : -1;
                        tableHTML += `<tr><td class="${hourClass}">${hourStr}</td><td>${this.utils.formatMinutesArray(minutes, minuteToHighlight)}</td></tr>`;
                    }
                    return tableHTML + '</tbody></table>';
                },

                // 8. GEOLOCATION
                
                handleDetectLocation() { /* ... same as before ... */ 
                    const geoMsgEl = this.elements.geolocationMessage;
                    if (navigator.geolocation) {
                        geoMsgEl.textContent = "正在獲取您的位置...";
                        geoMsgEl.classList.remove('hidden');

                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                geoMsgEl.classList.add('hidden');
                                this.state.userPosition = { lat: position.coords.latitude, lon: position.coords.longitude };
                                
                                const allLocations = [
                                    ...this.config.locations.out.map(loc => ({ ...loc, group: 'out' })),
                                    ...this.config.locations.home.map(loc => ({ ...loc, group: 'home' }))
                                ];
                                
                                let nearestLocation = null;
                                let shortestDistance = Infinity;

                                allLocations.forEach(loc => {
                                    const distance = this.utils.calculateDistance(this.state.userPosition.lat, this.state.userPosition.lon, loc.lat, loc.lon);
                                    if (distance < shortestDistance) {
                                        shortestDistance = distance;
                                        nearestLocation = loc;
                                    }
                                });

                                if (nearestLocation) {
                                    this.handleMainTabClick(nearestLocation.group);
                                    const buttonToSelect = Array.from(this.elements.locationSelector.querySelectorAll('button')).find(btn => btn.value === nearestLocation.name); 
                                    if (buttonToSelect) this.selectLocationButton(buttonToSelect);
                                } else {
                                    this.handleMainTabClick('home');
                                }
                            },
                            (error) => {
                                console.warn("Could not get location:", error.message);
                                geoMsgEl.textContent = "無法獲取位置，請手動選擇。";
                                geoMsgEl.classList.remove('hidden');
                                this.handleMainTabClick('home');
                            },
                            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                        );
                    } else {
                        geoMsgEl.textContent = "您的瀏覽器不支援地理位置。";
                        geoMsgEl.classList.remove('hidden');
                        this.handleMainTabClick('home');
                    }
                },

                // 9. REFRESH LOGIC
                
                async handleRefresh() { /* ... same as before ... */ 
                    const etaViewVisible = !this.elements.etaView.classList.contains('hidden');
                    if (!etaViewVisible) return;
                    await this.displayDepartures(); 
                },

                // --- Pull to Refresh Handlers ---
                handleTouchStart(e) { /* ... same as before ... */ 
                    if (window.scrollY === 0 && !this.state.isRefreshing) {
                        this.state.ptrTouchStartY = e.touches[0].clientY;
                        this.elements.ptrIndicator.style.transition = 'none';
                    }
                },

                handleTouchMove(e) { /* ... same as before ... */ 
                    if (this.state.ptrTouchStartY === 0 || this.state.isRefreshing) return;

                    const currentY = e.touches[0].clientY;
                    const deltaY = currentY - this.state.ptrTouchStartY;

                    if (deltaY > 0 && window.scrollY === 0) {
                        e.preventDefault(); 
                        this.elements.ptrIndicator.style.opacity = '1';
                        this.elements.ptrIndicator.style.height = Math.min(deltaY * 0.6, this.state.ptrThreshold + 20) + 'px';
                        this.elements.ptrSpinner.classList.add('hidden');
                        this.elements.ptrTextEl.textContent = deltaY > this.state.ptrThreshold ? "釋放以更新" : "下拉以更新";
                    } else if (deltaY < 0) {
                        this.state.ptrTouchStartY = 0;
                    }
                },

                async handleTouchEnd(e) { /* ... same as before ... */ 
                    if (this.state.ptrTouchStartY === 0) return;
                    
                    const deltaY = e.changedTouches[0].clientY - this.state.ptrTouchStartY;
                    this.state.ptrTouchStartY = 0;
                    this.elements.ptrIndicator.style.transition = 'height 0.3s ease-out, opacity 0.3s ease-out';

                    if (deltaY > this.state.ptrThreshold && !this.state.isRefreshing) {
                        this.elements.ptrIndicator.style.height = '60px';
                        this.elements.ptrTextEl.textContent = '更新中...';
                        this.elements.ptrSpinner.classList.remove('hidden');
                        
                        await this.handleRefresh(); 
                        
                        setTimeout(() => {
                            this.elements.ptrIndicator.style.height = '0px';
                            this.elements.ptrIndicator.style.opacity = '0';
                        }, 500); 
                    } else {
                        this.elements.ptrIndicator.style.height = '0px';
                        this.elements.ptrIndicator.style.opacity = '0';
                    }
                },


                // 10. UTILITIES
                utils: { /* ... all util functions remain the same ... */ 
                    getCurrentHktTime() {
                        const now = new Date();
                        const hktTimeString = now.toLocaleTimeString('en-GB', { timeZone: 'Asia/Hong_Kong' });
                        const hktTimeParts = hktTimeString.split(':');
                        return {
                            hour: parseInt(hktTimeParts[0], 10),
                            minute: parseInt(hktTimeParts[1], 10)
                        };
                    },

                    formatDepartureTime(hour, minute) {
                        return `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                    },
                    
                    getUpcomingDepartures(schedule, currentHour, currentMinute, count = 5) {
                        if (!schedule) return [];
                        const upcoming = [];
                        const sortedHours = Object.keys(schedule).map(Number).sort((a, b) => a - b);
                        const now = new Date(); 

                        if (schedule[currentHour]) {
                            schedule[currentHour].forEach(minute => {
                                if (minute >= currentMinute && upcoming.length < count) {
                                    const depDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), currentHour, minute, 0);
                                    upcoming.push({ hour: currentHour, minute, date: depDate });
                                }
                            });
                        }

                        for (const hour of sortedHours) {
                            if (upcoming.length >= count) break;
                            if (hour > currentHour) { 
                                schedule[hour].forEach(minute => {
                                    if (upcoming.length < count) {
                                         const depDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, 0);
                                        upcoming.push({ hour, minute, date: depDate });
                                    }
                                });
                            }
                        }
                        return upcoming;
                    },

                    findNextGlobalDeparture(scheduleData, currentHour, currentMinute) {
                         if (!scheduleData) return null; 
                        let sortedHours = Object.keys(scheduleData).map(Number).sort((a,b) => a - b);
                        if (scheduleData[currentHour]) {
                            const minute = scheduleData[currentHour].find(m => m >= currentMinute);
                            if (minute !== undefined) return { hour: currentHour, minute: minute };
                        }
                        for (let h of sortedHours) {
                            if (h > currentHour) {
                                if (scheduleData[h] && scheduleData[h].length > 0) return { hour: h, minute: scheduleData[h][0] };
                            }
                        }
                        const firstHourOfService = sortedHours[0];
                        if (firstHourOfService !== undefined && scheduleData[firstHourOfService] && scheduleData[firstHourOfService].length > 0) { 
                           return { hour: firstHourOfService, minute: scheduleData[firstHourOfService][0] };
                        }
                        return null;
                    },

                    formatMinutesArray(minutesArray, highlightMinute = -1) {
                        if (!minutesArray || minutesArray.length === 0) return '-';
                        return minutesArray.map(min => {
                            const formattedMin = String(min).padStart(2, '0');
                            return (min === highlightMinute) ? `<span class="timetable-highlight-minute">${formattedMin}</span>` : formattedMin;
                        }).join(' ');
                    },

                    deg2rad(deg) {
                        return deg * (Math.PI/180);
                    },

                    calculateDistance(lat1, lon1, lat2, lon2) {
                        const R = 6371; // Radius of the earth in km
                        const dLat = this.deg2rad(lat2-lat1);
                        const dLon = this.deg2rad(lon2-lon1); 
                        const a = 
                            Math.sin(dLat/2) * Math.sin(dLat/2) +
                            Math.cos(this.deg2rad(lat1)) * Math.cos(this.deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
                        const d = R * c; // Distance in km
                        return d;
                    }
                }
            };

            // Start the application!
            App.init();
        });
    </script>
</body>
</html>

